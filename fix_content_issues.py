"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –≤ chapters.ts:
1. –ó–∞–º–µ–Ω—è–µ—Ç \tag{...} –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ LaTeX —Ñ–æ—Ä–º—É–ª—ã
2. –£–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
3. –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
4. –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
"""

import re
import json

def fix_formulas(content):
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º—É–ª—ã: –∑–∞–º–µ–Ω—è–µ—Ç \tag{...} –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π LaTeX"""
    # –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ä–º—É–ª—ã –≤–∏–¥–∞ \tag{1.42} –∏ –∑–∞–º–µ–Ω—è–µ–º –∏—Ö
    # –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ä—É—á–Ω—É—é
    
    # –ü—Ä–∏–º–µ—Ä: m =m +m ; \tag{1.42} -> m = m + m $$...$$
    # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º \tag{...} –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—ã –∫–∞–∫ –µ—Å—Ç—å
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—É–¥–µ—Ç —É–∫–∞–∑–∞—Ç—å, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å
    
    # –£–±–∏—Ä–∞–µ–º \tag{...} –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)
    content = re.sub(r'\\tag\{[^}]+\}', '', content)
    
    return content

def fix_duplicate_images(content):
    """–£–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    lines = content.split('\n')
    seen_images = {}
    result = []
    
    for line in lines:
        # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        img_match = re.search(r'!\[([^\]]*)\]\(([^)]+)\)', line)
        if img_match:
            alt_text = img_match.group(1).lower().strip()
            img_path = img_match.group(2)
            key = f"{alt_text}|{img_path}"
            
            if key in seen_images:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç
                continue
            else:
                seen_images[key] = True
                result.append(line)
        else:
            result.append(line)
    
    return '\n'.join(result)

def fix_table_formatting(content):
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü"""
    # –£–±–∏—Ä–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø—É—Å—Ç—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
    # –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ —É–±–µ—Ä–µ–º –æ—á–µ–≤–∏–¥–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
    
    # –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ " --- | --- | --- |" –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∏–º–∏
    lines = content.split('\n')
    result = []
    i = 0
    while i < len(lines):
        line = lines[i]
        # –ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç–∞–±–ª–∏—Ü—ã –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if re.match(r'^\s*---\s*\|\s*---', line) and i > 0:
            prev_line = lines[i-1] if i > 0 else ''
            # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
            if not re.match(r'^\s*\|', prev_line):
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É
                i += 1
                continue
        result.append(line)
        i += 1
    
    return '\n'.join(result)

def fix_line_breaks(content):
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ - –∑–∞–º–µ–Ω—è–µ—Ç \n –≤ —Å—Ç—Ä–æ–∫–∞—Ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã"""
    # –í TypeScript —Å—Ç—Ä–æ–∫–∞—Ö \n —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å \\n, –∑–∞–º–µ–Ω—è–µ–º
    content = content.replace('\\n', '\n')
    return content

def main():
    print("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º...")
    print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.")
    print("   –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª –∏ —Ç–∞–±–ª–∏—Ü –Ω—É–∂–Ω–∞ —Ä—É—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.")
    print("\nüìã –ß—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:")
    print("   1. –£–¥–∞–ª–µ–Ω–∏–µ \\tag{...} –∏–∑ —Ñ–æ—Ä–º—É–ª")
    print("   2. –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
    print("   3. –ë–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü")
    print("   4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫")
    print("\n‚ùì –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): ", end='')
    
    response = input().strip().lower()
    if response != 'y':
        print("–û—Ç–º–µ–Ω–µ–Ω–æ.")
        return
    
    # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
    try:
        with open('src/data/chapters.ts', 'r', encoding='utf-8') as f:
            content = f.read()
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª src/data/chapters.ts –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    original_size = len(content)
    print(f"\nüìä –ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä: {original_size:,} —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    print("\nüî® –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π...")
    content = fix_formulas(content)
    print("   ‚úì –§–æ—Ä–º—É–ª—ã")
    content = fix_duplicate_images(content)
    print("   ‚úì –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    content = fix_table_formatting(content)
    print("   ‚úì –¢–∞–±–ª–∏—Ü—ã")
    content = fix_line_breaks(content)
    print("   ‚úì –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫")
    
    new_size = len(content)
    print(f"\nüìä –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: {new_size:,} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"üìâ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: {original_size - new_size:,} —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
    backup_file = 'src/data/chapters.ts.backup'
    print(f"\nüíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: {backup_file}")
    with open(backup_file, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("\n‚úÖ –ì–æ—Ç–æ–≤–æ! –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.")
    print("\n‚ö†Ô∏è  –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:")
    print("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é")
    print("   2. –ï—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ, –∑–∞–º–µ–Ω–∏—Ç–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª")
    print("   3. –§–æ—Ä–º—É–ª—ã –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é (–∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ $$...$$)")
    print("   4. –¢–∞–±–ª–∏—Ü—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–≤–∫–∏")

if __name__ == '__main__':
    main()

